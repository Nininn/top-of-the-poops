<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Top of the Poops</title>
</head>

<body>

<div id="graph"></div>

<script type="module">
    import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6.3/+esm";
    import * as htl from 'https://cdn.jsdelivr.net/npm/htl@0.3.1/+esm';

    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)

    let colours = {
        domain: [
            "a-24",
            "z-0", "z-4", "z-8", "z-12", "z-16", "z-20", "z-24",
            "o-0", "o-4", "o-8", "o-12", "o-16", "o-20", "o-24",
            "p-0", "p-4", "p-8", "p-12", "p-16", "p-20", "p-24",
            "u-24"
        ],
        range: ["#28A64580",
            "#666666", "#666666", "#666666", "#666666", "#666666", "#666666", "#666666",
            "#f7a974", "#fda863", "#d44a04", "#d44a04", "#d44a04", "#842904", "#842904",
            "#d4d4e8", "#d4d4e8", "#b2b1d5", "#b2b1d5", "#7363ad", "#7363ad", "#460d83",
            "#3b9acb80"
        ],
    };

    fetch("bob.json")
        .then(r => r.json())
        .then(data => {

                const dates = data.dates.map( it => new Date(it))
                const dumps = data.data.map(it => { return {...it, d: new Date(it.d)}});

                const constituencies = [... new Set( dumps.map( it => it.c ))].sort();

                constituencies.map(constituency => {

                    const constituency_data = dumps.filter(it => it.c === constituency)

                    document.getElementById("graph").appendChild(
                        Plot.plot({
                            caption: htl.html`<i>${constituency}</i>`,
                            marginTop: 50,
                            marginLeft: 80,
                            marginBottom: 30,
                            width: Math.max(1150, vw - 50),
                            height: 200,
                            color: colours,
                            x: {
                                type: "band",
                                ticks: dates.filter((d, i) => i % 30 === 0),
                                padding: 0.1,
                            },
                            y: {
                                grid: true,
                                label: "",
                            },
                            marks: [
                                Plot.cell(
                                    constituency_data,
                                    {
                                        x: d => d.d,
                                        y: "p",
                                        fill: "a",
                                        // stroke: "a",
                                        // strokeWidth: 8
                                    }
                                ),
                            ]
                        })
                    )
                });
            }
        );

</script>
</body>
</html>